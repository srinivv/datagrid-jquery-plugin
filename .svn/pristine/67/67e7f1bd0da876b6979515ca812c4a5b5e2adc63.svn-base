<?xml version="1.0"?>

<project name="apa" default="default" basedir="./..">
    <description>
            Build script for APAS
    </description>
	
	<property name="src.dir" value="${basedir}/src" />
	<property name="lib.dir" value="${basedir}/WebRoot/WEB-INF/lib" />
	<property name="build.dir" value="${basedir}/build" />
	<property name="work.dir" value="${build.dir}/work" />
	<property name="classes.dir" value="${build.dir}/work/war/WEB-INF/classes" />
	<property environment="env" name="env.LANG" value="en_US"></property>

	
	<path id="sds.classpath">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
			<include name="**/*.zip" />
			
		</fileset>
		
		<fileset dir="${basedir}/local_lib">
			<include name="**/*.jar" />
			<include name="**/*.zip" />
		</fileset>
	</path>
	

    <!-- ================================= 
          target: default              
         ================================= -->
    <target name="default" depends="ear">
        
    </target>
	
	<target name="init" depends="clean">
		<mkdir dir="${work.dir}" />
		<mkdir dir="${work.dir}/war" />
		<mkdir dir="${work.dir}/war/WEB-INF" />
		<mkdir dir="${work.dir}/war/WEB-INF/classes" />

		<mkdir dir="${work.dir}/env" />
		<mkdir dir="${work.dir}/env/WEB-INF" />
		<mkdir dir="${work.dir}/env/WEB-INF/classes" />
	</target>	
	
	<target name="clean">
		<delete dir="${work.dir}" />
		<delete file="${build.dir}/${ant.project.name}.war"/>
	</target>

	<target name="compile" depends="init"> 
			<fileset dir="${basedir}/WebRoot" includes="**/*.gif" />
		  <fileset dir="${basedir}/WebRoot" includes="**/*.jpg" />	
			<fileset dir="${basedir}/WebRoot" includes="**/*.js" />
			<fileset dir="${basedir}/WebRoot" includes="**/*.css" />
		<javac
			classpathref="sds.classpath"
			srcdir="${src.dir}"
			destdir="${classes.dir}"
			debug="on">
		</javac>
	</target>
	
	<target name="war" depends="compile">
		
		<!-- Jar the Properties Files for Dev environment -->
		<copy overwrite="on" todir="${work.dir}/env/WEB-INF/classes/" >
			<fileset dir="${basedir}/properties/" />
			<mapper type="regexp" from="(.*)[-_]dev(.*)" to="\1\2" />
		</copy>	
		<copy overwrite="true" file="${basedir}/conf/datasources-config.xml.dev" tofile="${work.dir}/env/WEB-INF/datasources-config.xml"/>
		<jar destfile="${work.dir}/war/WEB-INF/cisco.dev.jar" 	basedir="${work.dir}/env/">	</jar>
			
		<!-- Jar the Properties Files for Stage environment -->
		<copy overwrite="on" todir="${work.dir}/env/WEB-INF/classes/">
			<fileset dir="${basedir}/properties/" />
			<mapper type="regexp" from="(.*)[-_]stage(.*)" to="\1\2" />
		</copy>	
		<copy overwrite="true" file="${basedir}/conf/datasources-config.xml.stg" tofile="${work.dir}/env/WEB-INF/datasources-config.xml"/>
		<jar destfile="${work.dir}/war/WEB-INF/cisco.stage.jar" 	basedir="${work.dir}/env/">	</jar>

		<!-- Jar the Properties Files for LT environment -->
		<copy overwrite="on" todir="${work.dir}/env/WEB-INF/classes/">
			<fileset dir="${basedir}/properties/" />
			<mapper type="regexp" from="(.*)[-_]lt(.*)" to="\1\2" />
		</copy>
		<copy overwrite="true" file="${basedir}/conf/datasources-config.xml.lt" tofile="${work.dir}/env/WEB-INF/datasources-config.xml"/>
		<jar destfile="${work.dir}/war/WEB-INF/cisco.lt.jar" 
			basedir="${work.dir}/env/">
		</jar>
			
	  	<!-- Jar the Properties Files for Prod environment -->
		<copy overwrite="on" todir="${work.dir}/env/WEB-INF/classes/">
			<fileset dir="${basedir}/properties/" />
			<mapper type="regexp" from="(.*)[-_]prod(.*)" to="\1\2" />
		</copy>	
		<copy overwrite="true" file="${basedir}/conf/datasources-config.xml.prod" tofile="${work.dir}/env/WEB-INF/datasources-config.xml"/>
		<jar destfile="${work.dir}/war/WEB-INF/cisco.prod.jar" 
			basedir="${work.dir}/env/">
		</jar>
		
		
		<copy todir="${work.dir}/war/WEB-INF/">
			<fileset dir="${basedir}/conf" >
				<exclude name="*.local" />
				<exclude name="datasources-config.xml.*" />
			</fileset>
		</copy>

		<copy todir="${work.dir}/war/WEB-INF/lib">
			<fileset dir="${lib.dir}" />
		</copy>
		
		<copy todir="${work.dir}/war/WEB-INF/classes">
			<fileset dir="${basedir}/properties" />
			<fileset dir="${src.dir}" >
			<include name="**/*.xml" />
			<include name="*.xsl"/>
			<include name="*.xls"/>
			<include name="*.properties" />
			</fileset>		
		</copy>
		
				
		<copy todir="${work.dir}/war">
			<fileset dir="${basedir}/WebRoot" >
				<exclude name="WEB-INF" />
			</fileset>
		</copy>

		<war destfile="${build.dir}/${ant.project.name}.war" 
			basedir="${work.dir}/war"
			update="yes"
			webxml="${work.dir}/war/WEB-INF/web.xml">
		</war>
	</target>

	<target name="ear" depends ="war">
      <echo message="ear running"/>
	   <jar jarfile="${build.dir}/${ant.project.name}.ear">
		 <fileset dir="${build.dir}" includes="${ant.project.name}.war"/>
		 <fileset dir="${basedir}/ear" />
	   </jar>
      <echo message="${ant.project.name}.ear is available in ${build.dir} directory."/>
	</target>
	
	<target name="deploy" description="Deploys to CCI environment">
		<copy todir="/opt/httpd/root/apps/apa/deploy/dev" overwrite="yes">
			<fileset dir="${build.dir}">
				<include name="${ant.project.name}.ear" />
			</fileset>
		</copy>
		
		<exec executable="/opt/httpd/tools61/deploy61">
			<arg line="-a apa  -f ${ant.project.name}.ear" />
		</exec>
	</target>
	
    <target name="all" depends="clean,war,ear,deploy" />
</project>

