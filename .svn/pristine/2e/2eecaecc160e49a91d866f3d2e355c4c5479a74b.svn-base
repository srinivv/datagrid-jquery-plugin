(function( $ ) {

	// Default - Global variables
	var $datatable;
	var meta;
	var itemsPerPage = 10; // Default page size
    var defaultPage = 0;
    var totalPageNoLinks;
	var source = '';
	var template = '';
	var showPagination;
	var extraParams = {};
	
	// Data grid method definitions
	var methods = {
    	
		// Default method
		init : function(options) { 

			$datatable = $(this);
			meta = $(this);
			
			source = options.source;
			template = $("#" + options.template);
			showPagination = options.pagination;
			if(options.pagesize) {
				itemsPerPage = options.pagesize;
			}

			var params = { start: 1, end: itemsPerPage, pagesize: itemsPerPage };
			if (options.params) {
				extraParams = options.params;
				params = $.extend({}, params, extraParams);
			}
			
			$.getJSON(source, params,  function(json) {
				//console.log(json);
				var totalRows = json.totalRows;
				$datatable.html(
		     			_.template(template.html(), { data: json.rows, total: totalRows }
		     	));
				
				var totalRows = json.totalRows;
	     		if (showPagination && totalRows > itemsPerPage) {

	     			// Initialize meta data
	     			meta.data('currentPage', defaultPage);

	     			$datatable.append(pagination(json));
	     			
	     			// Bind click events
	     			bindPaginationEvents();
	     		}
			});
     		
     		
     		return $datatable;
    	},
        
		// Show data grid if it is hidden
    	show : function() {
    		$(this).slideDown();
    	},
    	
    	// Reload the grid
    	reload : function() { 
			meta = $(this);
			
			var params = { start: 1, end: itemsPerPage, pagesize: itemsPerPage };
			if (extraParams) {
				params = $.extend({}, params, extraParams);
			}
			
			$.getJSON(source, params,  function(json) {
				//console.log(json);
				var totalRows = json.totalRows;
				$datatable.html(
		     			_.template(template.html(), { data: json.rows, total: totalRows }
		     	));
				
				var totalRows = json.totalRows;
	     		if (showPagination && totalRows > itemsPerPage) {
	     			meta.data('currentPage', 0);
	     			$datatable.append(pagination(json));
	     		}
			});
     		
    	}
    };

	// Data Grid definition
    $.fn.datagrid = function(options) {
    	if ( methods[options] ) {
    		return methods[ options ].apply( this, Array.prototype.slice.call( arguments, 1 ));
    	} else if ( typeof options === 'object' || ! options ) {
            // Default to "init"
    		return methods.init.apply( this, arguments );
    	} else {
    		$.error( 'Method ' +  method + ' does not exist on jQuery.datagrid' );
    	}    
    };

	function pagination(response) {
		
		// Get the total number of items
		var totalRows = response.totalRows;
		
		// Default - Items per page
		meta.data('itemsPerPage', itemsPerPage);
	
		// Calculate the number of pages needed
		var numberOfPages = Math.ceil(totalRows/itemsPerPage);
	
		// Navigation order
		var navOrder = ["first", "prev", "num", "next", "last"];
		
		// Construct the nav bar
		var more = '<span class="more">...</span>';
	    var first = '<a class="first" href="#">First</a>';
	    var last = '<a class="last" href="#">Last</a>';
	    var prev = '<a class="prev" href="#">Prev</a>';
	    var next = '<a class="next" href="#">Next</a>';
		var less = '<span class="less">...</span>';
		
		var numPageLinksToDisplay = 20;
	
		var paginationHtml = "<div class='pagination_values alignright'>";
	
		for(var i = 0; i < navOrder.length; i++) {
			switch (navOrder[i]) {
				case "first":
					paginationHtml += first;
					break;
				case "last":
					paginationHtml += last;
					break;
				case "next":
					paginationHtml += next;
					break;
				case "prev":
					paginationHtml += prev;
					break;
				case "num":
					var currentLink = 0;
					totalPageNoLinks = 0;
					while (numberOfPages > currentLink) {
					if (currentLink == 0)
						paginationHtml += '<a class="pageno active_page current" '
								+ ' href="#" longdesc="'
								+ currentLink
								+ '">'
								+ (currentLink + 1)
								+ '</a>';
					else
						paginationHtml += '<a class="pageno" href="#" longdesc="'
								+ currentLink
								+ '">'
								+ (currentLink + 1)
								+ '</a>';
					currentLink++;
					totalPageNoLinks++;
				}
					break;
				default:
					break;
			}
		}
		paginationHtml += "</div>";
		
		$(".pagination_values").find('.prev').next().next().addClass('active_page current');
		
		return paginationHtml;
		
	}
	
	function showPrevPage(e){
		newPage = parseInt(meta.data('currentPage')) - 1;

		// Check that we aren't on a boundary link
		if(newPage >= 0) {
			gotopage(newPage);
		} 
	};

	function showNextPage(e){
		newPage = parseInt(meta.data('currentPage')) + 1;

		// Check that we aren't on a boundary link
		if(newPage < totalPageNoLinks) {
			gotopage(newPage);
		}
	};

	function gotopage(pageNumber){

		// Reassign the active class
		$(".pagination_values").children('.pageno[longdesc=' + pageNumber +']')
				.addClass('active_page current')
				.siblings('.active_page')
				.removeClass('active_page current');

		// Set the current page meta data
		meta.data('currentPage', pageNumber);

		// Requesting page number from server
		var pageNo = parseInt(pageNumber);
		//console.log('Loading Page # ' + pageNo + 1);
		
		var startRow = (pageNo * itemsPerPage) + 1;
		var endRow = (startRow + itemsPerPage) - 1;
		
		var params = { start: startRow, end: endRow, pagesize: itemsPerPage };
		if (extraParams) {
			params = $.extend({}, params, extraParams);
		}
		
		$.getJSON(source, params,  function(json) {
			//console.log(json);
			var totalRows = json.totalRows;
			$datatable.html(
	     			_.template(template.html(), { data: json.rows, total: totalRows }
	     	));
			
			var totalRows = json.totalRows;
     		if (showPagination && totalRows > itemsPerPage) {

     			// Initialize meta data
     			meta.data('currentPage', pageNumber);

     			$datatable.append(pagination(json));

     			// Reassign the active class
     			$(".pagination_values").children('.pageno[longdesc=' + pageNumber +']')
     					.addClass('active_page current')
     					.siblings('.active_page')
     					.removeClass('active_page current');
     			
     		}
		});
		
	};
	
	//Bind the actions to their respective links 
	function bindPaginationEvents() {

		// Event handler for 'First' link
		$('.first').live("click", function(e){
			e.preventDefault();
			var firstPage = 0;
			gotopage(firstPage);
		});

		// Event handler for 'Last' link
		$('.last').live("click", function(e){
			e.preventDefault();
			var lastPage = totalPageNoLinks - 1;
			gotopage(lastPage);
		});

		// Event handler for 'Prev' link
		$('.prev').live("click", function(e){
			e.preventDefault();
			showPrevPage($(this));
		});


		// Event handler for 'Next' link
		$('.next').live("click", function(e){
			e.preventDefault();
			showNextPage($(this));
		});

		// Event handler for each 'Page' link
		$('.pageno').live("click", function(e){
			e.preventDefault();
			gotopage($(this).attr('longdesc'));
		});

		// Goto the required page
		//gotopage(defaultPage);
		
	};

    
})( jQuery );